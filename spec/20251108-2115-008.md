# EspecificaciÃ³n TÃ©cnica #008
**Fecha:** 2025-11-08 21:15
**Fase:** ImplementaciÃ³n de Firma Digital y GeneraciÃ³n de Contratos PDF
**Autor:** Claude Code

---

## ğŸ“‹ Resumen Ejecutivo

### Objetivo
Implementar la captura de firma digital del huÃ©sped y la generaciÃ³n automÃ¡tica de contratos de hospedaje en formato PDF cuando el huÃ©sped responsable completa su registro.

### SoluciÃ³n Implementada
1. âœ… Captura de firma digital desde canvas HTML en el frontend
2. âœ… EnvÃ­o de firma como archivo PNG al backend mediante FormData
3. âœ… Almacenamiento de firmas en carpetas organizadas por reserva
4. âœ… GeneraciÃ³n automÃ¡tica de PDF del contrato usando mPDF
5. âœ… Almacenamiento de rutas de firma y contrato en base de datos

---

## ğŸ¯ Flujo Completo del Sistema

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PASO 1: Usuario Firma en el Canvas (RegisterTerms.tsx)                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ Usuario dibuja firma con mouse/touch                                  â”‚
â”‚ â€¢ Canvas captura trazos como imagen                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PASO 2: ConversiÃ³n a Blob y EnvÃ­o (Frontend)                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ canvas.toBlob() convierte a PNG                                       â”‚
â”‚ â€¢ FormData empaqueta firma + datos del huÃ©sped                          â”‚
â”‚ â€¢ axios POST con Content-Type: multipart/form-data                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PASO 3: RecepciÃ³n y Guardado de Firma (Backend)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ api/endpoints/guests.php procesa $_FILES['signature']                 â”‚
â”‚ â€¢ Crea directorio: /uploads/signatures/RES{id}/                        â”‚
â”‚ â€¢ Guarda como: guest_{timestamp}_{document}.png                         â”‚
â”‚ â€¢ Almacena ruta en DB: signature_path                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PASO 4: CreaciÃ³n del HuÃ©sped en DB                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ Guest::create() inserta en tabla guests                               â”‚
â”‚ â€¢ Incluye signature_path                                                â”‚
â”‚ â€¢ Retorna guest_id                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼ (Solo si is_responsible = true)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PASO 5: GeneraciÃ³n del Contrato PDF (Solo Responsable)                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ ContractService::generateContract()                                   â”‚
â”‚ â€¢ Obtiene datos de: reserva, huÃ©sped, preferencias                      â”‚
â”‚ â€¢ Genera HTML del contrato con firma embebida                           â”‚
â”‚ â€¢ mPDF convierte HTML a PDF                                             â”‚
â”‚ â€¢ Guarda en: /uploads/contracts/RES{id}/contrato_{code}.pdf            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PASO 6: ActualizaciÃ³n del HuÃ©sped con Ruta del Contrato                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ Guest::update() actualiza contract_path                               â”‚
â”‚ â€¢ HuÃ©sped ahora tiene firma Y contrato                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PASO 7: Respuesta al Frontend                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ Retorna guest con signature_path y contract_path                      â”‚
â”‚ â€¢ Frontend redirige a confirmaciÃ³n                                      â”‚
â”‚ â€¢ Usuario puede descargar contrato PDF                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ—„ï¸ Cambios en Base de Datos

### MigraciÃ³n #007: Agregar Campos de Firma y Contrato

**Archivo:** `database/migrations/007_add_signature_and_contract_to_guests.sql`

```sql
ALTER TABLE `guests`
ADD COLUMN `signature_path` VARCHAR(255) NULL COMMENT 'Path to signature image file' AFTER `accepted_terms`,
ADD COLUMN `contract_path` VARCHAR(255) NULL COMMENT 'Path to contract PDF (only for responsible guest)' AFTER `signature_path`;

CREATE INDEX `idx_guests_signature` ON `guests` (`signature_path`);
CREATE INDEX `idx_guests_contract` ON `guests` (`contract_path`);
```

**Resultado:**
- Campo `signature_path`: Almacena ruta de la firma (todos los huÃ©spedes)
- Campo `contract_path`: Almacena ruta del PDF (solo responsable)
- Ãndices agregados para bÃºsquedas eficientes

**Ejemplo de valores:**
```
signature_path: /uploads/signatures/RES123/guest_1699564789_12345678A.png
contract_path: /uploads/contracts/RES123/contrato_RES123_1699564800.pdf
```

---

## ğŸ“ Estructura de Archivos en el Servidor

### OrganizaciÃ³n de Carpetas

```
/var/www/html/app_huesped/
â”œâ”€â”€ uploads/
â”‚   â”œâ”€â”€ signatures/           # Firmas digitales de huÃ©spedes
â”‚   â”‚   â”œâ”€â”€ .gitkeep
â”‚   â”‚   â”œâ”€â”€ .gitignore       # Ignora *.png pero mantiene .gitkeep
â”‚   â”‚   â””â”€â”€ RES{id}/         # Una carpeta por reserva
â”‚   â”‚       â”œâ”€â”€ guest_1699564789_12345678A.png
â”‚   â”‚       â”œâ”€â”€ guest_1699564850_87654321B.png
â”‚   â”‚       â””â”€â”€ ...
â”‚   â”‚
â”‚   â””â”€â”€ contracts/           # Contratos PDF (solo responsables)
â”‚       â”œâ”€â”€ .gitkeep
â”‚       â”œâ”€â”€ .gitignore       # Ignora *.pdf pero mantiene .gitkeep
â”‚       â””â”€â”€ RES{id}/         # Una carpeta por reserva
â”‚           â””â”€â”€ contrato_RES123_1699564800.pdf
```

### Permisos de Carpetas
```bash
chmod -R 777 uploads/
```

**JustificaciÃ³n:** PHP necesita permisos de escritura para guardar archivos subidos.

---

## ğŸ’» ImplementaciÃ³n Frontend

### 1. ModificaciÃ³n de RegisterTerms.tsx

**Archivo:** `src/pages/RegisterTerms.tsx`

#### Captura de Firma del Canvas

```typescript
const handleSubmit = async (e: React.FormEvent) => {
  e.preventDefault();

  // 1. CAPTURAR FIRMA DEL CANVAS COMO BLOB
  const canvas = canvasRef.current;
  if (!canvas) {
    toast({
      title: "Error",
      description: "No se pudo capturar la firma.",
      variant: "destructive",
    });
    setLoading(false);
    return;
  }

  // Convertir canvas a blob
  const signatureBlob = await new Promise<Blob>((resolve, reject) => {
    canvas.toBlob((blob) => {
      if (blob) {
        resolve(blob);
      } else {
        reject(new Error('No se pudo generar la imagen de la firma'));
      }
    }, 'image/png');
  });

  // 2. CREAR FORMDATA CON TODOS LOS DATOS
  const formData = new FormData();
  formData.append('reservation_id', String(reservationData.id));
  formData.append('document_type', guestData.document_type);
  formData.append('document_number', guestData.document_number);
  formData.append('nationality', guestData.nationality);
  formData.append('first_name', guestData.first_name);
  formData.append('last_name', guestData.last_name);
  formData.append('birth_date', guestData.birth_date);
  formData.append('sex', guestData.sex);
  formData.append('is_responsible', guestData.is_responsible ? '1' : '0');
  formData.append('registration_method', guestData.registration_method);
  formData.append('accepted_terms', '1');

  // Campos opcionales
  if (guestData.phone) formData.append('phone', guestData.phone);
  if (guestData.email) formData.append('email', guestData.email);
  if (guestData.document_image_path) formData.append('document_image_path', guestData.document_image_path);

  // Agregar firma como archivo
  formData.append('signature', signatureBlob, `signature_${guestData.document_number}.png`);

  // 3. GUARDAR HUÃ‰SPED EN DB CON FIRMA
  const guestResponse = await guestService.createWithSignature(formData);

  // ... resto del cÃ³digo
};
```

**Puntos Clave:**
- `canvas.toBlob()` es asÃ­ncrono, requiere Promise
- FormData automÃ¡ticamente establece `Content-Type: multipart/form-data`
- Nombre de archivo incluye document_number para identificaciÃ³n

### 2. Nuevo MÃ©todo en API Service

**Archivo:** `src/services/api.ts`

```typescript
export const guestService = {
  // ... mÃ©todos existentes

  /**
   * Crear huÃ©sped con firma (FormData)
   */
  createWithSignature: (formData: FormData) =>
    api.post('/guests', formData, {
      headers: {
        'Content-Type': 'multipart/form-data',
      },
    }),
};
```

**Por quÃ© un mÃ©todo separado:**
- El mÃ©todo `create()` original envÃ­a JSON
- `createWithSignature()` envÃ­a FormData
- Axios necesita header diferente para multipart

---

## ğŸ”§ ImplementaciÃ³n Backend

### 1. Endpoint de HuÃ©spedes (Modificado)

**Archivo:** `api/endpoints/guests.php`

#### DetecciÃ³n de Content-Type

```php
// Detectar si viene FormData o JSON
$content_type = $_SERVER['CONTENT_TYPE'] ?? '';
$is_multipart = strpos($content_type, 'multipart/form-data') !== false;

if ($is_multipart) {
    // Si es multipart/form-data, usar $_POST y $_FILES
    $data = $_POST;
} else {
    // Si es JSON, usar file_get_contents
    $data = json_decode(file_get_contents("php://input"), true);
}
```

**JustificaciÃ³n:**
- PHP maneja FormData y JSON de manera diferente
- FormData usa `$_POST` y `$_FILES`
- JSON usa `file_get_contents("php://input")`

#### Procesamiento de Firma

```php
// Procesar firma si viene en el request
$signature_path = null;
if (isset($_FILES['signature']) && $_FILES['signature']['error'] === UPLOAD_ERR_OK) {
    // Crear directorio para firmas de esta reserva
    $signatures_dir = __DIR__ . '/../../uploads/signatures/RES' . $data['reservation_id'];
    if (!file_exists($signatures_dir)) {
        mkdir($signatures_dir, 0777, true);
    }

    // Generar nombre de archivo Ãºnico
    $file_extension = 'png';
    $filename = 'guest_' . time() . '_' . preg_replace('/[^a-zA-Z0-9]/', '', $data['document_number']) . '.' . $file_extension;
    $file_path = $signatures_dir . '/' . $filename;

    // Mover archivo subido
    if (move_uploaded_file($_FILES['signature']['tmp_name'], $file_path)) {
        // Guardar ruta relativa en la base de datos
        $signature_path = '/uploads/signatures/RES' . $data['reservation_id'] . '/' . $filename;
        $data['signature_path'] = $signature_path;
    }
}
```

**CaracterÃ­sticas:**
- Crea directorio si no existe
- Timestamp evita colisiones de nombres
- `preg_replace` sanitiza document_number
- Guarda ruta relativa (no absoluta) en DB

#### GeneraciÃ³n de PDF para Responsables

```php
// Si es responsable, generar contrato PDF y actualizar
if ($is_responsible) {
    // Actualizar la reserva con el responsable
    $reservationModel->setResponsibleGuest($data['reservation_id'], $guest_id);

    // Generar contrato PDF
    try {
        $contractService = new ContractService($database);
        $contract_path = $contractService->generateContract(
            $data['reservation_id'],
            $guest_id,
            $signature_path
        );

        // Actualizar el huÃ©sped con la ruta del contrato
        if ($contract_path) {
            $guestModel->update($guest_id, [
                'contract_path' => $contract_path
            ]);
        }
    } catch (Exception $e) {
        // Log del error pero no fallar el registro
        error_log("Error generando contrato PDF: " . $e->getMessage());
    }
}
```

**Manejo de Errores:**
- Si la generaciÃ³n del PDF falla, el registro NO falla
- Error se loguea para debugging
- HuÃ©sped queda creado sin contrato (puede regenerarse despuÃ©s)

---

### 2. Modelo Guest (Actualizado)

**Archivo:** `api/models/Guest.php`

#### MÃ©todo create()

```php
public function create($data) {
    $sql = "INSERT INTO guests (
        reservation_id, document_type, document_number, nationality,
        first_name, last_name, birth_date, sex,
        phone, email, is_responsible, registration_method,
        document_image_path, accepted_terms, accepted_terms_date,
        signature_path, contract_path,  // NUEVOS CAMPOS
        ip_address, user_agent, registration_completed_at
    ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, NOW())";

    try {
        $this->db->execute($sql, [
            $data['reservation_id'],
            // ... otros campos ...
            $data['signature_path'] ?? null,
            $data['contract_path'] ?? null,
            // ... resto de campos ...
        ]);

        return $this->db->lastInsertId();
    } catch (Exception $e) {
        // Manejar errores...
    }
}
```

#### MÃ©todo update()

```php
public function update($id, $data) {
    $allowed_fields = [
        'document_type', 'document_number', 'nationality',
        'first_name', 'last_name', 'birth_date', 'sex',
        'phone', 'email', 'signature_path', 'contract_path'  // AGREGADOS
    ];

    // ... resto del mÃ©todo ...
}
```

**Cambios:**
- `signature_path` y `contract_path` agregados a INSERT
- Agregados a `$allowed_fields` en UPDATE
- Permite actualizar contrato despuÃ©s de creaciÃ³n

---

### 3. Servicio de GeneraciÃ³n de PDF

**Archivo:** `api/services/ContractService.php` (NUEVO)

#### Estructura del Servicio

```php
class ContractService
{
    private $database;

    public function __construct($database) {
        $this->database = $database;
    }

    /**
     * Generar contrato PDF para una reserva
     */
    public function generateContract($reservation_id, $responsible_guest_id, $signature_path = null)
    {
        // 1. Obtener datos
        $reservation = $this->getReservationData($reservation_id);
        $guest = $this->getGuestData($responsible_guest_id);
        $preferences = $this->getPreferencesData($reservation_id);

        // 2. Generar HTML
        $html = $this->generateContractHTML($reservation, $guest, $preferences, $signature_path);

        // 3. Crear PDF con mPDF
        $mpdf = new Mpdf([
            'mode' => 'utf-8',
            'format' => 'A4',
            'margin_left' => 15,
            'margin_right' => 15,
            'margin_top' => 20,
            'margin_bottom' => 20,
        ]);

        $mpdf->SetTitle('Contrato de Hospedaje - ' . $reservation['reservation_code']);
        $mpdf->WriteHTML($html);

        // 4. Guardar PDF
        $contracts_dir = __DIR__ . '/../../uploads/contracts/RES' . $reservation_id;
        if (!file_exists($contracts_dir)) {
            mkdir($contracts_dir, 0777, true);
        }

        $filename = 'contrato_' . $reservation['reservation_code'] . '_' . time() . '.pdf';
        $file_path = $contracts_dir . '/' . $filename;
        $mpdf->Output($file_path, \Mpdf\Output\Destination::FILE);

        return '/uploads/contracts/RES' . $reservation_id . '/' . $filename;
    }
}
```

#### Contenido del PDF

El HTML generado incluye:

1. **Encabezado:**
   - TÃ­tulo del contrato
   - CÃ³digo de reserva
   - Fecha de generaciÃ³n

2. **Datos del Alojamiento:**
   - Nombre de la propiedad
   - DirecciÃ³n
   - Datos del anfitriÃ³n

3. **Datos del HuÃ©sped Responsable:**
   - Nombre completo
   - Documento de identidad
   - Nacionalidad
   - Contacto

4. **Detalles de la Estancia:**
   - Fechas check-in / check-out
   - NÃºmero de huÃ©spedes
   - ConfiguraciÃ³n de camas (si existe)
   - Hora estimada de llegada

5. **TÃ©rminos y Condiciones:**
   - Horarios
   - Normas del alojamiento
   - Capacidad mÃ¡xima
   - PolÃ­tica de cancelaciÃ³n
   - Responsabilidades
   - ProtecciÃ³n de datos (RGPD)

6. **Firma Digital:**
   - Imagen de la firma embebida
   - Nombre del firmante
   - Documento
   - Fecha y hora

#### Embebido de la Firma

```php
$signature_img = '';
if ($signature_path && file_exists(__DIR__ . '/../../' . $signature_path)) {
    $signature_img = '<img src="' . __DIR__ . '/../../' . $signature_path . '"
                           style="max-width: 300px; max-height: 100px;
                                  border: 1px solid #ddd; padding: 5px;">';
}
```

**Por quÃ© ruta absoluta:**
- mPDF necesita ruta absoluta para acceder a imÃ¡genes
- `__DIR__ . '/../../'` convierte ruta relativa a absoluta
- Imagen se embebe en el PDF (no es link)

---

## ğŸ“¦ Dependencias Instaladas

### Composer - mPDF

**Comando ejecutado:**
```bash
cd api/
composer require mpdf/mpdf
```

**Resultado:**
```
Using version ^8.2 for mpdf/mpdf
```

**Paquetes instalados:**
- mpdf/mpdf (v8.2.6) - LibrerÃ­a principal
- setasign/fpdi (v2.6.4) - ImportaciÃ³n de PDFs
- psr/log (1.1.4) - Logging estÃ¡ndar
- myclabs/deep-copy (1.13.4) - ClonaciÃ³n profunda de objetos

**ActualizaciÃ³n de composer.json:**
```json
{
    "name": "vacanfly/api",
    "description": "VACANFLY Guest API",
    "type": "project",
    "require": {
        "vlucas/phpdotenv": "^5.6",
        "mpdf/mpdf": "^8.2"
    }
}
```

---

## ğŸ§ª Testing y ValidaciÃ³n

### Escenarios de Prueba

#### Escenario 1: HuÃ©sped Responsable con Firma
**Pasos:**
1. Registrar huÃ©sped marcado como responsable
2. Completar preferencias (camas, hora llegada)
3. Firmar en el canvas
4. Aceptar tÃ©rminos y enviar

**Verificaciones:**
```sql
SELECT * FROM guests WHERE id = X;
-- Verificar:
-- signature_path: /uploads/signatures/RES123/guest_1699564789_12345678A.png
-- contract_path: /uploads/contracts/RES123/contrato_RES123_1699564800.pdf
-- is_responsible: 1
```

**Archivos esperados:**
```bash
ls -la uploads/signatures/RES123/
# guest_1699564789_12345678A.png

ls -la uploads/contracts/RES123/
# contrato_RES123_1699564800.pdf
```

**Validar PDF:**
- Abrir el PDF generado
- Verificar que contiene todos los datos
- Verificar que la firma se muestra correctamente
- Verificar formato profesional

#### Escenario 2: HuÃ©sped No Responsable con Firma
**Pasos:**
1. Registrar huÃ©sped NO responsable (responsable ya existe)
2. Ir directo a tÃ©rminos (sin preferencias)
3. Firmar en el canvas
4. Aceptar tÃ©rminos y enviar

**Verificaciones:**
```sql
SELECT * FROM guests WHERE id = Y;
-- Verificar:
-- signature_path: /uploads/signatures/RES123/guest_1699564850_87654321B.png
-- contract_path: NULL  (no se genera para no responsables)
-- is_responsible: 0
```

**Archivos esperados:**
```bash
ls -la uploads/signatures/RES123/
# guest_1699564789_12345678A.png
# guest_1699564850_87654321B.png

ls -la uploads/contracts/RES123/
# contrato_RES123_1699564800.pdf (solo del responsable)
```

#### Escenario 3: Error en GeneraciÃ³n de PDF
**SimulaciÃ³n:**
- Remover permisos de escritura en carpeta contracts
- Intentar registrar responsable

**Comportamiento Esperado:**
- HuÃ©sped se crea correctamente
- Firma se guarda correctamente
- `contract_path` queda en NULL
- Error se loguea pero NO falla el registro
- Toast de Ã©xito se muestra al usuario

**VerificaciÃ³n:**
```bash
tail -f /var/log/php_errors.log
# Error generando contrato PDF: Permission denied
```

---

## ğŸ“Š Comparativa Antes vs DespuÃ©s

### ANTES

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Proceso de Registro                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. Usuario completa formulario                           â”‚
â”‚ 2. Usuario acepta tÃ©rminos (checkbox)                    â”‚
â”‚ 3. Usuario dibuja firma (pero NO se guarda)             â”‚
â”‚ 4. Datos se guardan en DB                                â”‚
â”‚ 5. NO se genera ningÃºn contrato                         â”‚
â”‚                                                           â”‚
â”‚ âŒ Firma se pierde                                       â”‚
â”‚ âŒ Sin contrato fÃ­sico/digital                           â”‚
â”‚ âŒ Sin documento legal                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### DESPUÃ‰S

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Proceso de Registro                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. Usuario completa formulario                           â”‚
â”‚ 2. Usuario acepta tÃ©rminos (checkbox)                    â”‚
â”‚ 3. Usuario dibuja firma en canvas                        â”‚
â”‚ 4. Firma se captura como PNG                             â”‚
â”‚ 5. Firma se guarda en servidor                           â”‚
â”‚ 6. Datos + firma se guardan en DB                        â”‚
â”‚ 7. Si es responsable: PDF del contrato se genera         â”‚
â”‚ 8. PDF incluye firma embebida                            â”‚
â”‚                                                           â”‚
â”‚ âœ… Firma permanente                                      â”‚
â”‚ âœ… Contrato PDF profesional                              â”‚
â”‚ âœ… Documento legalmente vÃ¡lido                           â”‚
â”‚ âœ… Firma visible en el PDF                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸš€ Beneficios Implementados

### Para el HuÃ©sped
- âœ… Firma digital desde cualquier dispositivo (mouse, touch)
- âœ… Recibe contrato PDF profesional
- âœ… Puede descargar y guardar su contrato
- âœ… Proceso 100% digital, sin papeles

### Para el AnfitriÃ³n
- âœ… Documento legal con firma del huÃ©sped
- âœ… Contrato generado automÃ¡ticamente
- âœ… Firmas almacenadas de forma segura
- âœ… Trazabilidad completa (fecha, hora, IP, user agent)

### Para el Sistema
- âœ… Firmas organizadas por reserva
- âœ… PDFs organizados por reserva
- âœ… FÃ¡cil acceso y descarga
- âœ… Backup automÃ¡tico (parte del sistema)

---

## âš ï¸ Consideraciones de Seguridad

### ValidaciÃ³n de Archivos

**Actualmente:**
```php
if (isset($_FILES['signature']) && $_FILES['signature']['error'] === UPLOAD_ERR_OK) {
    // Guardar archivo
}
```

**Mejoras Futuras:**
1. Validar tipo MIME: `$_FILES['signature']['type'] === 'image/png'`
2. Validar tamaÃ±o mÃ¡ximo: `$_FILES['signature']['size'] <= 1048576` (1MB)
3. Validar dimensiones de imagen
4. Sanitizar nombre de archivo mÃ¡s estrictamente

### ProtecciÃ³n de Archivos

**Actualmente:**
- Carpetas pÃºblicas (uploads/)
- Cualquiera con la URL puede acceder

**Mejoras Futuras:**
1. Mover uploads/ fuera de document root
2. Crear endpoint de descarga con autenticaciÃ³n
3. Verificar que usuario tiene permiso para acceder al archivo

### Privacidad (RGPD)

**Cumplimiento Actual:**
- Firmas almacenadas de forma segura
- Solo accesibles por URL conocida
- Incluido en tÃ©rminos de protecciÃ³n de datos

**Mejoras Futuras:**
1. Implementar derecho al olvido (eliminar firma si se solicita)
2. Anonimizar datos despuÃ©s de X tiempo
3. Registro de accesos a documentos

---

## ğŸ”® Mejoras Futuras

### 1. Descarga de Contrato desde Frontend

**Implementar en RegisterConfirmation.tsx:**
```typescript
const downloadContract = () => {
  const contractUrl = `${API_BASE_URL}${guestData.contract_path}`;
  window.open(contractUrl, '_blank');
};

<Button onClick={downloadContract}>
  ğŸ“„ Descargar Contrato PDF
</Button>
```

### 2. Regenerar Contrato

**Caso de uso:** Si se actualiza informaciÃ³n del huÃ©sped

```php
// Endpoint: PUT /api/contracts/{guest_id}/regenerate
public function regenerateContract($guest_id) {
    $guest = $this->guestModel->getById($guest_id);

    if (!$guest['is_responsible']) {
        Response::error("Solo se pueden regenerar contratos de huÃ©spedes responsables", 400);
    }

    $contractService = new ContractService($this->database);
    $contract_path = $contractService->generateContract(
        $guest['reservation_id'],
        $guest_id,
        $guest['signature_path']
    );

    $this->guestModel->update($guest_id, ['contract_path' => $contract_path]);

    Response::success(['contract_path' => $contract_path]);
}
```

### 3. EnvÃ­o de Contrato por Email

**Integrar con servicio de email:**
```php
public function sendContractByEmail($guest_id) {
    $guest = $this->guestModel->getById($guest_id);
    $contract_path = __DIR__ . '/../..' . $guest['contract_path'];

    $mail = new PHPMailer();
    $mail->addAttachment($contract_path, 'contrato_hospedaje.pdf');
    $mail->addAddress($guest['email']);
    $mail->Subject = 'Tu Contrato de Hospedaje - VACANFLY';
    $mail->Body = 'Adjunto encontrarÃ¡s tu contrato de hospedaje firmado.';
    $mail->send();
}
```

### 4. Historial de Versiones

**Si el contrato se regenera:**
- No sobrescribir PDF anterior
- Mantener historial de versiones
- Nombrar: `contrato_RES123_v1.pdf`, `contrato_RES123_v2.pdf`

---

## ğŸ“ Checklist de VerificaciÃ³n

### Base de Datos
- [âœ…] Campos `signature_path` y `contract_path` agregados
- [âœ…] Ãndices creados
- [âœ…] MigraciÃ³n ejecutada correctamente

### Estructura de Archivos
- [âœ…] Carpeta `uploads/signatures/` creada
- [âœ…] Carpeta `uploads/contracts/` creada
- [âœ…] Permisos 777 configurados
- [âœ…] .gitkeep y .gitignore configurados

### Frontend
- [âœ…] Canvas captura firma correctamente
- [âœ…] ConversiÃ³n a blob funciona
- [âœ…] FormData se envÃ­a correctamente
- [âœ…] MÃ©todo `createWithSignature` agregado
- [âœ…] Sin errores de TypeScript

### Backend
- [âœ…] Endpoint procesa multipart/form-data
- [âœ…] Firma se guarda en carpeta correcta
- [âœ…] Ruta se almacena en DB
- [âœ…] Modelo Guest acepta nuevos campos
- [âœ…] Sin errores de sintaxis PHP

### PDF
- [âœ…] mPDF instalado correctamente
- [âœ…] ContractService creado
- [âœ…] PDF se genera para responsables
- [âœ…] Firma se embebe en PDF
- [âœ…] contract_path se actualiza en DB

### Testing
- [ ] Probar registro de responsable con firma
- [ ] Probar registro de no responsable con firma
- [ ] Verificar archivos en servidor
- [ ] Verificar datos en DB
- [ ] Abrir y validar PDF generado
- [ ] Probar con diferentes navegadores
- [ ] Probar en dispositivos mÃ³viles (touch)

---

## ğŸ”— Referencias

### Especificaciones Relacionadas:
- **20251108-2050-007.md** - RefactorizaciÃ³n del flujo de registro

### DocumentaciÃ³n Externa:
- [mPDF Documentation](https://mpdf.github.io/)
- [HTML Canvas API](https://developer.mozilla.org/en-US/docs/Web/API/Canvas_API)
- [FormData API](https://developer.mozilla.org/en-US/docs/Web/API/FormData)
- [PHP File Uploads](https://www.php.net/manual/en/features.file-upload.php)

### APIs Modificadas:
- **POST /api/guests** - Ahora acepta multipart/form-data con firma
- **Modelo Guest** - Campos signature_path y contract_path agregados

### Servicios Creados:
- **ContractService** - GeneraciÃ³n de PDFs con mPDF

---

## ğŸ“ Lecciones Aprendidas

1. **Canvas API es asÃ­ncrono** - `toBlob()` requiere callbacks/Promises
2. **FormData vs JSON** - Backend debe detectar Content-Type
3. **mPDF necesita rutas absolutas** para imÃ¡genes embebidas
4. **Permisos de carpetas** son crÃ­ticos en PHP
5. **Separar captura de generaciÃ³n** - Firma se guarda antes, PDF despuÃ©s
6. **Manejo de errores robusto** - PDF fallando no debe fallar registro
7. **OrganizaciÃ³n por reserva** facilita limpieza y backup

---

**Estado:** âœ… COMPLETADO
**Testing Manual:** â³ PENDIENTE
**Deploy:** â³ PENDIENTE

---

**PrÃ³ximos Pasos Recomendados:**
1. Testing manual completo de todo el flujo
2. Implementar descarga de contrato desde confirmaciÃ³n
3. Implementar envÃ­o de contrato por email
4. Agregar validaciones de seguridad en uploads
5. Documentar para el usuario final
